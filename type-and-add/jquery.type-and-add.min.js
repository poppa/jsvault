/*!
 * Like the "add people to invite" function on Google+. Lets you type in an
 * invisible input field. A callback is called and if an array is passed back
 * from there a drop-down list is populated from which you can choose.
 *
 * Copyright © 2009-2015 Pontus Östlund <https://profiles.google.com/poppanator>
 *
 * Permission to copy, modify, and distribute this source for any legal
 * purpose granted as long as my name is still attached to it. More
 * specifically, the GPL, LGPL and MPL licenses apply to this software.
 */
!function(t,n,e){"use strict";if(void 0===e)throw"jQuery not available";var i=!1,o=".sx-container {z-index: 2;width: auto;max-width: 350px;max-height: 300px;overflow-y: auto;position: absolute;background: white;border: 1px solid #aaa;margin-top: -1px;margin-left: 0px;box-shadow: 2px 2px 5px rgba(0,0,0,.2);}.sx-container a {display: block;padding: 5px 5px;border-bottom: 1px dotted #ccc;overflow: hidden;text-overflow: ellipsis;white-space: nowrap;text-decoration:none;min-width:180px;}.sx-container a:focus,.sx-container a:active { background: #f1f1f1; }.sx-container a:hover { background: #f1f1f1; }.sx-container a:last-child { border-bottom: none; }",a=function(t,a){var r,c,d,u,f,l,h,p,y,g,v,b=this,x=new s;i||(i=!0,e("head").prepend("<style>"+o+"</style>")),t=e.extend({searchDelay:500,searchMinLength:3,onSearch:function(){},onAdd:function(){},onRemove:function(){},defaultData:null,duplicates:!1,max:0},t),a=e(a),l=e('<i class="fa fa-spinner fa-spin"></i>'),a.append(l),l.css({position:"absolute",zIndex:3}).hide(),g=function(){l.css({left:d.position().left+d.outerWidth(),top:d.position().top+(d.outerHeight()/2-l.outerHeight()/2)}).fadeIn("fast")},c=a.find("a"),v=c.attr("data-type-and-add-placeholder")?c.attr("data-type-and-add-placeholder"):c.text(),d=e('<input type="text" placeholder="'+v+'" />').css({border:"none",background:"transparent",display:"none"}).addClass("type-and-find"),d[0].noblur=!1,d.click(function(t){t.stopPropagation()}).on("focus",function(){h.show(),e(n).on("click.typeandadd",function(){u(!0)})}).on("blur",function(){u()}).on("keyup",function(n){var e=d.val();0===e.length&&h.close(),n.ctrlKey===!0||e.length<t.searchMinLength||n.keyCode<49&&(45!==n.keyCode||46!==n.keyCode)&&8!==n.keyCode||(g(),r.search(e))}).on("keydown",function(){r.abort()}),a.prepend(d).keyup(function(t){if(27===t.keyCode)return d[0].noblur=!1,u(),void c.focus()}),u=function(t){(t||d[0].noblur===!1||h.isClosed())&&(d.css("display","none"),y(),l.fadeOut("fast"),h.close(),d[0].noblur=!1,e(n).off("click.typeandadd"))},f=function(){return!(t.max&&x.length()>=t.max)},p=function(n){var i=e('<a href="#">');return i.text(n.display||"?").attr("title",n.title||"").click(function(n){return n.stopPropagation(),t.onAdd(e.data(this,"typeandadd"),b,this)!==!1&&(x.add(e.data(this,"typeandadd")),e(this).css({display:"inline-block"}).addClass("selected-item").unbind("click").click(function(){return t.onRemove(e.data(this,"typeandadd"),b,this)!==!1&&(b.remove(this),u(!0),c.focus()),!1}).focus(function(t){t.stopPropagation()}).blur(function(t){t.stopPropagation(),d.trigger("blur")}).insertBefore(d)),u(!0),y(!0),!1}).keyup(function(t){46!==t.keyCode&&8!==t.keyCode||e(this).click()}),e.data(i[0],"typeandadd",n),i};var k=function(){this.isSearching=!1,this.ival=0,this.search=function(n){this.isSearching||(this.ival&&clearTimeout(this.ival),this.ival=setTimeout(function(){r.isSearching=!0,t.onSearch(n,b)},300))},this.abort=function(){r.isSearching=!1,clearTimeout(this.ival)}};r=new k;var m=function(){var n=e('<div class="sx-container">').hide();n.insertAfter(d).click(function(t){return t.stopPropagation(),!1}),this.populate=function(e){for(var i,o,a=n.find("a"),s=0;s<e.length;s++)i=e[s],!t.duplicates&&x.exists(i)||(o=p(i),n.append(o));a.remove(),this.show()},this.isClosed=function(){return"none"===n.css("display")},this.close=function(t){t?(n.hide(),n.empty()):(n.slideUp("fast",function(){n.empty()}),d[0].noblur=!1)},this.show=function(){n.find("a").length&&n.slideDown("fast"),n.css({left:d.position().left}),d[0].noblur=!0}};if(h=new m,y=function(t){f()?(c.css("display","inline-block"),t&&c.trigger("click")):c.css("display","none")},c.click(function(t){return h.close(!0),t.stopPropagation(),e(this).hide(),d.css("display","inline-block").val("").focus(),!1}),this.remove=function(t){x.remove(e.data(t,"typeandadd")),e(t).remove()},this.populatePopup=function(t){return l.fadeOut("fast"),!this.isAborted()&&t&&t.length?(r.abort(),void h.populate(t)):void h.close()},this.getSelections=function(){return x.getList()},this.isAborted=function(){return r.isSearching===!1},this.reset=function(){x.clear(),a.find("a.selected-item").remove(),u(!0)},t.defaultData)for(var w=0;w<t.defaultData.length;w++)p(t.defaultData[w]).click()},s=function(){var t=[];this.length=function(){return t.length},this.getList=function(){return t},this.add=function(n){t.push(n)},this.remove=function(n){var e=[];for(var i in t)r(t[i],n)||e.push(t[i]);t=e},this.exists=function(n){for(var e=0;e<t.length;e++)if(r(t[e],n))return!0;return!1},this.clear=function(){t=[]}},r=function(t,n){var e=typeof t,i=typeof n;if(e!==i)return!1;if("object"!==e)return"function"===e?t.length===n.length:t===n;for(var o in t){if(!(o in n))return!1;var a=t[o],s=n[o];return typeof a==typeof s&&("object"==typeof a?r(a,s):"function"==typeof a?a.length===s.length:t[o]===n[o])}};e.fn.typeAndAdd=function(t){return this.each(function(){if(t){var n=new a(t,this);e.data(this,"typeAndAdd",n)}})},e.fn.typeAndAddReset=function(){return this.each(function(){var t=e.data(this,"typeAndAdd");t&&t.reset()})}}(window,document,jQuery);
/*!
 * Like the "add people to invite" function on Google+. Lets you type in an
 * invisible input field. A callback is called and if an array is passed back
 * from there a drop-down list is populated from which you can choose.
 *
 * Copyright © 2009-2015 Pontus Östlund <https://profiles.google.com/poppanator>
 *
 * Permission to copy, modify, and distribute this source for any legal
 * purpose granted as long as my name is still attached to it. More
 * specifically, the GPL, LGPL and MPL licenses apply to this software.
 */
!function(t,n){"use strict";if(void 0==n)throw"jQuery not available";var e=!1,i=".sx-container {z-index: 2;width: auto;max-width: 350px;max-height: 300px;overflow-y: auto;position: absolute;background: white;border: 1px solid #aaa;margin-top: -1px;margin-left: 0px;box-shadow: 2px 2px 5px rgba(0,0,0,.2);}.sx-container a {display: block;padding: 5px 5px;border-bottom: 1px dotted #ccc;overflow: hidden;text-overflow: ellipsis;white-space: nowrap;text-decoration:none;min-width:180px;}.sx-container a:focus,.sx-container a:active { background: #f1f1f1; }.sx-container a:hover { background: #f1f1f1; }.sx-container a:last-child { border-bottom: none; }",o=function(t,o){var s,r,c,d,u,l,f,h,p,y,v,g=this,b=new a;if(e||(e=!0,n("head").prepend("<style>"+i+"</style>")),t=n.extend({searchDelay:500,searchMinLength:3,onSearch:function(){},onAdd:function(){},onRemove:function(){},defaultData:null,duplicates:!1,max:0},t),o=n(o),l=n('<i class="fa fa-spinner fa-spin"></i>'),o.append(l),l.css({position:"absolute",zIndex:3}).hide(),y=function(){l.css({left:c.position().left+c.outerWidth(),top:c.position().top+(c.outerHeight()/2-l.outerHeight()/2)}).fadeIn("fast")},r=o.find("a"),v=r.attr("data-type-and-add-placeholder")?r.attr("data-type-and-add-placeholder"):r.text(),c=n('<input type="text" placeholder="'+v+'" />').css({border:"none",background:"transparent",display:"none"}).addClass("type-and-find"),c[0].noblur=!1,c.click(function(t){t.stopPropagation()}).on("focus",function(){f.show(),n(document).on("click.typeandadd",function(){d(!0)})}).on("blur",function(){d()}).on("keyup",function(n){var e=c.val();0===e.length&&f.close(),n.ctrlKey===!0||e.length<t.searchMinLength||n.keyCode<49&&(45!==n.keyCode||46!==n.keyCode)&&8!==n.keyCode||(y(),s.search(e))}).on("keydown",function(){s.abort()}),o.prepend(c).keyup(function(t){return 27===t.keyCode?(c[0].noblur=!1,d(),void r.focus()):void 0}),d=function(t){(t||c[0].noblur===!1||f.isClosed())&&(c.css("display","none"),p(),l.fadeOut("fast"),f.close(),c[0].noblur=!1,n(document).off("click.typeandadd"))},u=function(){return!(t.max&&b.length()>=t.max)},h=function(e){var i=n('<a href="#">');return i.text(e.display||"?").attr("title",e.title||"").click(function(e){return e.stopPropagation(),t.onAdd(n.data(this,"typeandadd"),g,this)!==!1&&(b.add(n.data(this,"typeandadd")),n(this).css({display:"inline-block"}).addClass("selected-item").unbind("click").click(function(){return t.onRemove(n.data(this,"typeandadd"),g,this)!==!1&&(g.remove(this),d(!0),r.focus()),!1}).focus(function(t){t.stopPropagation()}).blur(function(t){t.stopPropagation(),c.trigger("blur")}).insertBefore(c)),d(!0),p(!0),!1}).keyup(function(t){(46===t.keyCode||8===t.keyCode)&&n(this).click()}),n.data(i[0],"typeandadd",e),i},s=new function(){this.isSearching=!1,this.ival=0,this.search=function(n){this.isSearching||(this.ival&&clearInterval(this.ival),this.ival=setTimeout(function(){s.isSearching=!0,t.onSearch(n,g)},300))},this.abort=function(){s.isSearching=!1,clearInterval(this.ival)}},f=new function(){var e=n('<div class="sx-container">').hide();e.insertAfter(c).click(function(t){return t.stopPropagation(),!1}),this.populate=function(n){for(var i,o,a=e.find("a"),s=0;s<n.length;s++)i=n[s],(t.duplicates||!b.exists(i))&&(o=h(i),e.append(o));a.remove(),this.show()},this.isClosed=function(){return"none"===e.css("display")},this.close=function(t){t?(e.hide(),e.empty()):(e.slideUp("fast",function(){e.empty()}),c[0].noblur=!1)},this.show=function(){e.find("a").length&&e.slideDown("fast"),e.css({left:c.position().left}),c[0].noblur=!0}},p=function(t){u()?(r.css("display","inline-block"),t&&r.trigger("click")):r.css("display","none")},r.click(function(t){return f.close(!0),t.stopPropagation(),n(this).hide(),c.css("display","inline-block").val("").focus(),!1}),this.remove=function(t){b.remove(n.data(t,"typeandadd")),n(t).remove()},this.populatePopup=function(t){return l.fadeOut("fast"),!this.isAborted()&&t&&t.length?(s.abort(),void f.populate(t)):void f.close()},this.getSelections=function(){return b.getList()},this.isAborted=function(){return s.isSearching===!1},this.reset=function(){b.clear(),o.find("a.selected-item").remove(),d(!0)},t.defaultData)for(var x=0;x<t.defaultData.length;x++)h(t.defaultData[x]).click()},a=function(){var t=[];this.length=function(){return t.length},this.getList=function(){return t},this.add=function(n){t.push(n)},this.remove=function(n){var e=[];for(var i in t)s(t[i],n)||e.push(t[i]);t=e},this.exists=function(n){for(var e=0;e<t.length;e++)if(s(t[e],n))return!0;return!1},this.clear=function(){t=[]}},s=function(t,n){var e=typeof t,i=typeof n;if(e!==i)return!1;if("object"!==e)return"function"===e?t.length===n.length:t===n;for(var o in t){if(!(o in n))return!1;var a=t[o],r=n[o];return typeof a!=typeof r?!1:"object"==typeof a?s(a,r):"function"==typeof a?a.length===r.length:t[o]===n[o]}};n.fn.typeAndAdd=function(t){return this.each(function(){if(t){var e=new o(t,this);n.data(this,"typeAndAdd",e)}})},n.fn.typeAndAddReset=function(){return this.each(function(){var t=n.data(this,"typeAndAdd");t&&t.reset()})}}(window,jQuery);